@login_required
def pay_advance_paypal(request, commission_id):
    commission = get_object_or_404(Commission, id=commission_id, client=request.user)
    
    if not commission.advance_amount or commission.advance_paid:
        messages.info(request, "Advance already paid or not set.")
        return redirect("client_commissions")

    payment = paypalrestsdk.Payment({
        "intent": "sale",
        "payer": {
            "payment_method": "paypal"
        },
        "redirect_urls": {
            "return_url": request.build_absolute_uri(f"/commission/paypal/success/{commission.id}/"),
            "cancel_url": request.build_absolute_uri("/client-commissions/")
        },
        "transactions": [{
            "item_list": {
                "items": [{
                    "name": commission.title,
                    "sku": f"commission_{commission.id}",
                    "price": str(commission.advance_amount),
                    "currency": "INR",
                    "quantity": 1
                }]
            },
            "amount": {
                "total": str(commission.advance_amount),
                "currency": "INR"
            },
            "description": f"Advance payment for commission {commission.title}"
        }]
    })

    if payment.create():
        # Redirect user to PayPal approval URL
        for link in payment.links:
            if link.rel == "approval_url":
                return redirect(link.href)
    else:
        messages.error(request, "Error creating PayPal payment.")
        return redirect("client_commissions")
