{% extends "masterss.html" %}
{% block title %}Request Commission{% endblock %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-5">

    <!-- BACK BUTTON -->
    <div class="mb-4">
        <a href="{% url 'artist_profile' artist.id %}" class="btn btn-outline-secondary rounded-pill">
            ‚Üê Back
        </a>
    </div>

    <!-- ARTIST INFO LEFT-ALIGNED -->
    <div class="d-flex align-items-center mb-4">
        {% if artist.profile_image %}
            <img src="{{ artist.profile_image.url }}" class="rounded-circle me-3" style="width:60px; height:60px; object-fit:cover;">
        {% else %}
            <i class="fas fa-user-circle fa-3x text-muted me-3"></i>
        {% endif %}
        <div>
            <h5 class="mb-0">{{ artist.name }}</h5>
            {% if artist.bio %}
                <small class="text-muted">{{ artist.bio|truncatechars:120 }}</small>
            {% endif %}
        </div>
    </div>

    <!-- COMMISSION FORM -->
    <form method="POST" enctype="multipart/form-data" class="card p-4 shadow-sm rounded-4 bg-light">
        {% csrf_token %}

        <!-- TITLE -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Artwork Title</label>
            {{ form.title|add_class:"form-control" }}
        </div>

        <!-- DESCRIPTION -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Description</label>
            {{ form.description|add_class:"form-control" }}
        </div>

        <!-- REQUIRED DATE -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Required Date</label>
            {{ form.required_date|add_class:"form-control" }}
            <small class="text-muted">Select a future date for delivery.</small>
        </div>

        <!-- REFERENCE IMAGE -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Reference Image (optional)</label>
            <div class="mb-2 d-flex justify-content-start">
                <img id="preview-image" src="#" alt="Reference Preview"
                     class="img-fluid rounded shadow-sm"
                     style="max-height:250px; display:none; object-fit:cover;">
            </div>
            {{ form.reference_image|add_class:"form-control" }}
        </div>

        <!-- DELIVERY ADDRESS -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Delivery Address</label>
            {{ form.delivery_address|add_class:"form-control" }}
        </div>

        <!-- USE MY LOCATION -->
        <div class="mb-3">
            <button type="button" onclick="getGPSLocation()" class="btn btn-outline-primary rounded-pill">
                üìç Use My Current Location
            </button>
            <span id="location-status" class="ms-2 text-success fw-semibold"></span>
        </div>

        <!-- SHOW PLACE NAME -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Selected Location</label>
            <input type="text" id="place-name" class="form-control" readonly>
        </div>

        <!-- MAP PREVIEW -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Tap on Map to Choose Location</label>
            <div id="map" style="height:300px; border-radius:15px; border:1px solid #ccc;"></div>
        </div>

        <!-- HIDDEN LAT/LONG -->
        {{ form.delivery_latitude }}
        {{ form.delivery_longitude }}

        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 mt-2">
            Submit Request
        </button>
    </form>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    let map;
    let marker;

    // Initialize map centered on India
    document.addEventListener("DOMContentLoaded", () => {
        map = L.map('map').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Click on map to select location
        map.on("click", async function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            setLocation(lat, lon);
        });
    });

    // Set location (lat/lon + marker + address)
    async function setLocation(lat, lon) {

        // Update hidden fields
        document.querySelector("input[name='delivery_latitude']").value = lat;
        document.querySelector("input[name='delivery_longitude']").value = lon;

        // Move or create marker
        if (!marker) {
            marker = L.marker([lat, lon]).addTo(map);
        } else {
            marker.setLatLng([lat, lon]);
        }

        // Move map focus
        map.setView([lat, lon], 15);

        // Reverse geocoding
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            document.getElementById("place-name").value =
                data.display_name || "Selected location";

        } catch {
            document.getElementById("place-name").value = "Could not detect address";
        }
    }

    // Use GPS location
    function getGPSLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    document.getElementById("location-status").textContent = "Location added ‚úì";
                    setLocation(pos.coords.latitude, pos.coords.longitude);
                },
                () => {
                    document.getElementById("location-status").textContent =
                        "Please allow GPS permission.";
                }
            );
        }
    }
</script>

<style>
    body { background-color: #F4EFE8; }

    .card.bg-light {
        background: #FFF8EE;
        border-radius: 20px;
        padding: 32px;
    }

    .form-control {
        border-radius: 30px;
        border: 1px solid #D2C2A8;
        padding: 10px 16px;
        background-color: #FFFDF8;
    }

    .btn-primary {
        background-color: #6A4632;
        color: #FFF8E7;
    }

    #preview-image {
        border-radius: 12px;
        border: 1px solid #ddd;
    }
</style>
{% endblock %}
